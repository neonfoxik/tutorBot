{% extends "crm/base.html" %}
{% load dict_filters %}

{% block title %}Группы • TutorBot CRM{% endblock %}

{% block content %}
<section class="panel">
    <div class="panel-header">
        <p class="panel-title">Группы</p>
        <p style="color: var(--muted); font-size: 0.9rem;">Выберите группу, чтобы увидеть журнал и отметить посещаемость.</p>
    </div>

    <div class="groups-layout">
        <div class="groups-grid">
            {% for group in groups %}
                <article class="group-card{% if selected_group and group.id == selected_group.id %} is-active{% endif %}">
                    <div>
                        <p class="group-card__title">{{ group.name }}</p>
                        <p class="group-card__meta">Преподаватель: {{ group.teacher }}</p>
                    </div>
                    <div class="group-card__footer">
                        <span>{{ group.students.count }} учеников</span>
                        <a href="?group={{ group.id }}">Перейти</a>
                    </div>
                </article>
            {% empty %}
                <p>Групп не найдено.</p>
            {% endfor %}
        </div>

        <div class="detail-panel">
            {% if selected_group %}
                <div class="detail-panel__header">
                    <div>
                        <h2 class="group-card__title" style="margin-bottom: 0.25rem;">{{ selected_group.name }}</h2>
                        <p class="group-card__meta">Преподаватель: {{ selected_group.teacher }}</p>
                    </div>
                    <a href="{% url 'bot:group_detail' selected_group.id %}" class="crm-btn crm-btn--secondary">Открыть отдельно</a>
                </div>

                <section style="margin-bottom: 1.25rem;">
                    <div class="panel-header" style="padding: 0;">
                        <p class="panel-title" style="font-size: 1rem;">Ученики группы</p>
                    </div>
                    <table class="student-table">
                        <thead>
                            <tr>
                                <th>Ученик</th>
                                <th>Класс</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in selected_group.students.all %}
                                <tr>
                                    <td class="student-label">
                                        <span class="student-name">{{ student.profile_name }}</span>
                                        <a class="homework-link" href="{% url 'bot:student_homework_results' student.id %}">ДЗ</a>
                                    </td>
                                    <td>{{ student.class_number|default:"—" }}</td>
                                    <td>
                                        <form method="post" action="{% url 'bot:group_remove_student' selected_group.id student.id %}" onsubmit="return confirm('Удалить ученика из группы?');">
                                            {% csrf_token %}
                                            <button type="submit" class="secondary">Удалить</button>
                                        </form>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="3">В группе пока нет учеников.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <form class="inline-form" method="post" action="{% url 'bot:group_add_student' selected_group.id %}" style="margin-top: 0.75rem;">
                        {% csrf_token %}
                        <select name="student_id" required>
                            <option value="" selected disabled>Добавить ученика</option>
                            {% for student in free_students %}
                                <option value="{{ student.id }}">{{ student.profile_name }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" onclick="return confirm('Добавить ученика в группу?');">Добавить</button>
                    </form>
                </section>

                {% include "crm/partials/group_journal.html" with current_group=selected_group lessons=selected_lessons attendances=selected_attendances homeworks=selected_homeworks latest_lesson_id=selected_latest_lesson_id %}
            {% else %}
                <p style="color: var(--muted);">Выберите группу слева, чтобы увидеть подробности.</p>
            {% endif %}
        </div>
    </div>
</section>

<section class="panel free-panel">
    <div class="panel-header">
        <p class="panel-title">Ученики без групп</p>
    </div>
    {% if free_students %}
        <table class="student-table">
            <thead>
                <tr>
                    <th>Ученик</th>
                    <th>Класс</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for student in free_students %}
                    <tr>
                        <td>{{ student.profile_name }}</td>
                        <td>{{ student.class_number|default:"—" }}</td>
                        <td>
                            <form method="post" id="add-student-form-{{ student.id }}" class="inline-form" onsubmit="return confirm('Добавить ученика в выбранную группу?');">
                                {% csrf_token %}
                                <input type="hidden" name="student_id" value="{{ student.id }}">
                                <select name="group_id" required onchange="updateFormAction({{ student.id }}, this.value)">
                                    <option value="" selected disabled>Выберите группу</option>
                                    {% for group in groups %}
                                        <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit">Добавить</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Все ученики закреплены за группами.</p>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
    function updateFormAction(studentId, groupId) {
        if (groupId) {
            const form = document.getElementById('add-student-form-' + studentId);
            if (form) {
                form.action = "{% url 'bot:group_add_student' 0 %}".replace('0', groupId);
            }
        }
    }
</script>
{% endblock %}
